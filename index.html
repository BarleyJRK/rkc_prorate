<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recology King County - Service Proration Calculator</title>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f7fa;
            --bg-card: #ffffff;
            --text-primary: #1a202c;
            --text-secondary: #4a5568;
            --border-color: #e2e8f0;
            --accent-primary: #3182ce;
            --accent-hover: #2c5282;
            --success-color: #48bb78;
            --error-color: #f56565;
            --shadow: rgba(0, 0, 0, 0.1);
            --glow: rgba(49, 130, 206, 0.3);
        }

        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --border-color: #334155;
            --accent-primary: #60a5fa;
            --accent-hover: #3b82f6;
            --success-color: #34d399;
            --error-color: #f87171;
            --shadow: rgba(0, 0, 0, 0.5);
            --glow: rgba(96, 165, 250, 0.5);
        }

        @media (prefers-color-scheme: dark) {
            :root:not([data-theme]) {
                --bg-primary: #0f172a;
                --bg-secondary: #1e293b;
                --bg-card: #1e293b;
                --text-primary: #f1f5f9;
                --text-secondary: #cbd5e1;
                --border-color: #334155;
                --accent-primary: #60a5fa;
                --accent-hover: #3b82f6;
                --success-color: #34d399;
                --error-color: #f87171;
                --shadow: rgba(0, 0, 0, 0.5);
                --glow: rgba(96, 165, 250, 0.5);
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .header-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .header-buttons .btn,
        .header-buttons .theme-toggle {
            padding: 6px 12px;
            font-size: 0.75rem;
            min-width: 100px;
        }

        .clock-display {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 2px;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            color: var(--text-primary);
            font-weight: 600;
        }

        .clock-date {
            font-size: 0.875rem;
        }

        .clock-time {
            font-size: 0.875rem;
        }

        h1 {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary), var(--success-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .theme-toggle {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 50px;
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
        }

        .theme-toggle:hover {
            border-color: var(--accent-primary);
            box-shadow: 0 0 15px var(--glow);
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px var(--shadow);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 8px 15px var(--shadow);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input, select, textarea {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--glow);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            padding: 10px 0;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .radio-option input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .radio-option label {
            cursor: pointer;
            text-transform: none;
            font-weight: 500;
            color: var(--text-primary);
            letter-spacing: normal;
        }

        .btn {
            padding: 14px 32px;
            background: linear-gradient(135deg, var(--accent-primary), var(--success-color));
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 10px var(--glow);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--glow);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
            box-shadow: none;
        }

        .btn-secondary:hover {
            border-color: var(--accent-primary);
        }

        .result-container {
            background: var(--bg-secondary);
            border: 2px solid var(--accent-primary);
            border-radius: 12px;
            padding: 25px;
            margin-top: 20px;
            display: none;
        }

        .result-container.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-amount {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 15px;
        }

        .result-message {
            font-size: 1rem;
            color: var(--text-secondary);
            line-height: 1.8;
        }

        .result-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .result-actions .btn {
            padding: 10px 20px;
            font-size: 0.875rem;
        }

        .calculation-breakdown {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            display: none;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            line-height: 1.8;
        }

        .calculation-breakdown.show {
            display: block;
        }

        .calculation-breakdown .breakdown-line {
            margin: 5px 0;
        }

        .calculation-breakdown .breakdown-result {
            font-weight: bold;
            color: var(--accent-primary);
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid var(--border-color);
        }

        /* Visual Timeline */
        .visual-timeline {
            margin: 20px 0;
            padding: 20px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .timeline-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }

        .timeline-bar-container {
            position: relative;
            height: 40px;
            background: var(--bg-secondary);
            border-radius: 20px;
            overflow: hidden;
            border: 2px solid var(--border-color);
        }

        .timeline-bar {
            position: absolute;
            height: 100%;
            transition: all 0.5s ease;
        }

        .timeline-bar.active {
            background: linear-gradient(90deg, var(--success-color), var(--accent-primary));
            left: 0;
        }

        .timeline-bar.unused {
            background: linear-gradient(90deg, var(--error-color), #ff8a80);
            right: 0;
        }

        .timeline-marker {
            position: absolute;
            top: -5px;
            width: 4px;
            height: 50px;
            background: var(--text-primary);
            z-index: 10;
        }

        .timeline-marker-label {
            position: absolute;
            top: -25px;
            transform: translateX(-50%);
            font-size: 0.75rem;
            font-weight: bold;
            color: var(--text-primary);
            white-space: nowrap;
        }

        .timeline-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            font-size: 0.875rem;
        }

        .timeline-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .timeline-legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .error-message {
            background: var(--error-color);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }

        .error-message.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        .audit-log {
            max-height: 500px;
            overflow-y: auto;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .log-header h2 {
            font-size: 1.5rem;
            color: var(--text-primary);
        }

        .log-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.875rem;
            min-width: 200px;
        }

        .search-box:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .filter-select {
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .log-entry {
            background: var(--bg-secondary);
            border-left: 4px solid var(--accent-primary);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .log-entry:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 8px var(--shadow);
        }

        .log-entry-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .log-entry-amount {
            font-size: 1.25rem;
            color: var(--success-color);
            font-weight: 700;
        }

        .log-entry-details {
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.6;
        }

        .log-entry-notes {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border-color);
            font-style: italic;
            color: var(--text-secondary);
        }

        .empty-log {
            text-align: center;
            color: var(--text-secondary);
            padding: 40px;
            font-style: italic;
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-primary);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-hover);
        }

        /* Dashboard Modal */
        .dashboard-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .dashboard-overlay.show {
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .dashboard-content {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 30px;
            max-width: 900px;
            width: 100%;
            margin: 20px auto;
            box-shadow: 0 10px 40px var(--shadow);
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .dashboard-header h2 {
            margin: 0;
            font-size: 1.75rem;
            color: var(--text-primary);
        }

        .dashboard-close {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.5rem;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .dashboard-close:hover {
            background: var(--error-color);
            color: white;
            border-color: var(--error-color);
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Tooltip Styles */
        .tooltip-icon {
            display: inline-block;
            width: 18px;
            height: 18px;
            background: var(--accent-primary);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 18px;
            font-size: 12px;
            font-weight: bold;
            cursor: help;
            margin-left: 6px;
            position: relative;
        }

        .tooltip-icon:hover {
            background: var(--accent-hover);
        }

        .tooltip-icon::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--text-primary);
            color: var(--bg-primary);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 1000;
            font-weight: normal;
            line-height: 1.4;
            max-width: 250px;
            white-space: normal;
            text-align: left;
        }

        .tooltip-icon:hover::after {
            opacity: 1;
        }

        .tooltip-icon::before {
            content: '';
            position: absolute;
            bottom: 115%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--text-primary);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .tooltip-icon:hover::before {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.5rem;
            }

            .result-amount {
                font-size: 2rem;
            }

            .dashboard-content {
                padding: 20px;
            }

            .dashboard-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Recology King County - Service Proration Calculator</h1>
            <div class="header-actions">
                <div class="header-buttons">
                    <button class="btn btn-secondary" id="dashboardBtn">📊 Dashboard</button>
                    <button class="theme-toggle" id="themeToggle">
                        <span id="themeIcon">🌙</span>
                        <span id="themeText">Dark Mode</span>
                    </button>
                </div>
                <div class="clock-display">
                    <div class="clock-date" id="clockDate">--/--/--</div>
                    <div class="clock-time" id="clockTime">--:--:--</div>
                </div>
            </div>
        </header>

        <div class="card">
            <form id="prorationForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="invoiceCycle">
                            Invoice Cycle
                            <span class="tooltip-icon" data-tooltip="Select the customer's billing cycle. Commercial = monthly, Residential cycles bill quarterly.">?</span>
                        </label>
                        <select id="invoiceCycle" required>
                            <option value="">Select Cycle</option>
                            <option value="commercial">Commercial (Monthly)</option>
                            <option value="jajo">R1A2 JAJO (Jan/Apr/Jul/Oct)</option>
                            <option value="fman">R1A2 FMAN (Feb/May/Aug/Nov)</option>
                            <option value="mjsd">R1A2 MJSD (Mar/Jun/Sep/Dec)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="serviceDate">
                            Effective Date
                            <span class="tooltip-icon" data-tooltip="The date service ends. This date is NOT included in the billing period.">?</span>
                        </label>
                        <input type="date" id="serviceDate" required>
                        <!-- Hidden field to always use "stop" service type -->
                        <input type="hidden" name="serviceType" value="stop">
                    </div>

                    <div class="form-group">
                        <label for="serviceRate">
                            Monthly Service Rate ($)
                            <span class="tooltip-icon" data-tooltip="Enter the customer's monthly rate. For residential, this is the monthly rate (NOT the quarterly total).">?</span>
                        </label>
                        <input type="number" id="serviceRate" step="0.01" min="0" required placeholder="0.00">
                    </div>
                </div>

                <div class="form-group">
                    <label for="notes">Notes</label>
                    <textarea id="notes" placeholder="Enter any notes or description..."></textarea>
                </div>

                <div style="margin-top: 20px;">
                    <button type="submit" class="btn">Calculate Proration</button>
                </div>

                <div class="error-message" id="errorMessage"></div>

                <div class="result-container" id="resultContainer">
                    <div class="result-amount" id="resultAmount"></div>
                    <div class="result-message" id="resultMessage"></div>
                    <div id="visualTimeline"></div>
                    <div class="result-actions">
                        <button type="button" class="btn btn-secondary" id="showBreakdownBtn">Show Calculation Details</button>
                        <button type="button" class="btn btn-secondary" id="copyResultBtn">Copy Amount</button>
                        <button type="button" class="btn btn-secondary" id="copySummaryBtn">Copy Summary</button>
                    </div>
                    <div class="calculation-breakdown" id="calculationBreakdown"></div>
                </div>
            </form>
        </div>

        <div class="card">
            <div class="log-header">
                <h2>Calculation History</h2>
                <div class="log-controls">
                    <input type="text" class="search-box" id="logSearch" placeholder="🔍 Search logs...">
                    <select class="filter-select" id="logFilter">
                        <option value="all">All Entries</option>
                        <option value="start">Start Only</option>
                        <option value="stop">Stop Only</option>
                        <option value="credit">Credits Only</option>
                        <option value="charge">Charges Only</option>
                    </select>
                    <button type="button" class="btn btn-secondary" id="clearLog">Clear Log</button>
                </div>
            </div>
            <div class="audit-log" id="auditLog">
                <div class="empty-log">No calculations yet. Fill out the form above to get started.</div>
            </div>
        </div>
    </div>

    <!-- Dashboard Modal -->
    <div class="dashboard-overlay" id="dashboardOverlay">
        <div class="dashboard-content">
            <div class="dashboard-header">
                <h2>📊 Analytics Dashboard</h2>
                <div class="dashboard-close" id="dashboardClose">×</div>
            </div>

            <div class="dashboard-stats" id="dashboardStats">
                <!-- Stats will be populated by JavaScript -->
            </div>

            <div class="card">
                <h3 style="margin-bottom: 15px; color: var(--text-primary);">Recent Activity Breakdown</h3>
                <div id="dashboardActivityBreakdown"></div>
            </div>
        </div>
    </div>

    <script>
        // Theme Management
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        const themeText = document.getElementById('themeText');
        const html = document.documentElement;

        function getStoredTheme() {
            return localStorage.getItem('theme');
        }

        function setStoredTheme(theme) {
            localStorage.setItem('theme', theme);
        }

        function getSystemTheme() {
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }

        function applyTheme(theme) {
            if (theme === 'dark') {
                html.setAttribute('data-theme', 'dark');
                themeIcon.textContent = '☀️';
                themeText.textContent = 'Light Mode';
            } else {
                html.setAttribute('data-theme', 'light');
                themeIcon.textContent = '🌙';
                themeText.textContent = 'Dark Mode';
            }
        }

        function initTheme() {
            const storedTheme = getStoredTheme();
            const theme = storedTheme || getSystemTheme();
            applyTheme(theme);
        }

        themeToggle.addEventListener('click', () => {
            const currentTheme = html.getAttribute('data-theme') || getSystemTheme();
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
            setStoredTheme(newTheme);
        });

        // Billing Cycle Definitions
        const billingCycles = {
            commercial: {
                name: 'Commercial (Monthly)',
                getPeriod: (date) => {
                    const year = date.getFullYear();
                    const month = date.getMonth();
                    const periodStart = new Date(year, month, 1);
                    const periodEnd = new Date(year, month + 1, 0);
                    const billDate = new Date(year, month, 1);
                    return { periodStart, periodEnd, billDate };
                }
            },
            jajo: {
                name: 'R1A2 JAJO',
                periods: [
                    { months: [0, 1, 2], billMonth: 0, billDay: 31 },    // Jan-Mar, billed Jan 31
                    { months: [3, 4, 5], billMonth: 3, billDay: 30 },    // Apr-Jun, billed Apr 30
                    { months: [6, 7, 8], billMonth: 6, billDay: 31 },    // Jul-Sep, billed Jul 31
                    { months: [9, 10, 11], billMonth: 9, billDay: 31 }   // Oct-Dec, billed Oct 31
                ],
                getPeriod: (date) => {
                    return getQuarterlyPeriod(date, billingCycles.jajo.periods);
                }
            },
            fman: {
                name: 'R1A2 FMAN',
                periods: [
                    { months: [1, 2, 3], billMonth: 1, billDay: -1 },    // Feb-Apr, billed Feb 28/29
                    { months: [4, 5, 6], billMonth: 4, billDay: 31 },    // May-Jul, billed May 31
                    { months: [7, 8, 9], billMonth: 7, billDay: 31 },    // Aug-Oct, billed Aug 31
                    { months: [10, 11, 0], billMonth: 10, billDay: 30 }  // Nov-Jan, billed Nov 30
                ],
                getPeriod: (date) => {
                    return getQuarterlyPeriod(date, billingCycles.fman.periods, true);
                }
            },
            mjsd: {
                name: 'R1A2 MJSD',
                periods: [
                    { months: [2, 3, 4], billMonth: 2, billDay: 31 },    // Mar-May, billed Mar 31
                    { months: [5, 6, 7], billMonth: 5, billDay: 30 },    // Jun-Aug, billed Jun 30
                    { months: [8, 9, 10], billMonth: 8, billDay: 30 },   // Sep-Nov, billed Sep 30
                    { months: [11, 0, 1], billMonth: 11, billDay: 31 }   // Dec-Feb, billed Dec 31
                ],
                getPeriod: (date) => {
                    return getQuarterlyPeriod(date, billingCycles.mjsd.periods, true);
                }
            }
        };

        function getQuarterlyPeriod(date, periods, crossesYear = false) {
            const month = date.getMonth();
            const year = date.getFullYear();

            for (let period of periods) {
                if (period.months.includes(month)) {
                    // Check if this period crosses year boundary (has both late year and early year months)
                    const hasLateYearMonth = period.months.some(m => m >= 10);
                    const hasEarlyYearMonth = period.months.some(m => m <= 2);
                    const periodsYear = (hasLateYearMonth && hasEarlyYearMonth && month <= 2) ? year - 1 : year;

                    // Find actual first and last months by sorting
                    const sortedMonths = [...period.months].sort((a, b) => {
                        // If period crosses year, treat Jan/Feb as 12+, 13+ for sorting
                        const aVal = (hasLateYearMonth && a <= 2) ? a + 12 : a;
                        const bVal = (hasLateYearMonth && b <= 2) ? b + 12 : b;
                        return aVal - bVal;
                    });

                    const firstMonth = sortedMonths[0];
                    const lastMonth = sortedMonths[sortedMonths.length - 1];
                    const lastMonthActual = lastMonth >= 12 ? lastMonth - 12 : lastMonth;

                    // Calculate period start and end
                    const periodStart = new Date(periodsYear, firstMonth, 1);
                    let periodEnd;

                    if (lastMonthActual < firstMonth) {
                        // Period crosses into next year
                        periodEnd = new Date(periodsYear + 1, lastMonthActual + 1, 0);
                    } else {
                        // Period stays in same year
                        periodEnd = new Date(periodsYear, lastMonthActual + 1, 0);
                    }

                    // Calculate bill date
                    const billDay = period.billDay === -1 ? new Date(periodsYear, period.billMonth + 1, 0).getDate() : period.billDay;
                    const billDate = new Date(periodsYear, period.billMonth, billDay);

                    return { periodStart, periodEnd, billDate };
                }
            }
        }

        function getDaysBetween(startDate, endDate) {
            // Calculate inclusive days between two dates
            const oneDay = 24 * 60 * 60 * 1000;
            const start = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
            const end = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());
            return Math.round((end - start) / oneDay) + 1;
        }

        function formatDate(date) {
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        function formatCurrency(amount) {
            return '$' + amount.toFixed(2);
        }

        // Constants
        const MAX_MONTHLY_RATE = 10000;
        const MIN_MONTHLY_RATE = 0.01;
        const MAX_AUDIT_LOG_ENTRIES = 100;
        const AUDIT_LOG_RETENTION_DAYS = 3; // Business days

        // Helper function to calculate active days (DRY principle)
        function calculateActiveDays(serviceType, serviceDate, periodStart, periodEnd) {
            if (serviceType === 'start') {
                return getDaysBetween(serviceDate, periodEnd);
            } else {
                // Stop date is NOT included in service days - service stopped as of this date
                const dayBeforeStop = new Date(serviceDate);
                dayBeforeStop.setDate(dayBeforeStop.getDate() - 1);

                // Edge case: if stop date is on or before period start, no active days
                if (dayBeforeStop < periodStart) {
                    return 0;
                }

                return getDaysBetween(periodStart, dayBeforeStop);
            }
        }

        // Helper function to count months in period (for residential billing)
        function countMonthsInPeriod(periodStart, periodEnd) {
            let count = 0;
            let current = new Date(periodStart);

            while (current <= periodEnd) {
                count++;
                current = new Date(current.getFullYear(), current.getMonth() + 1, 1);
            }

            return count;
        }

        function calculateProration(cycleType, serviceType, serviceDate, monthlyRate) {
            const cycle = billingCycles[cycleType];
            const period = cycle.getPeriod(serviceDate);

            // Calculate total days in period
            const totalDays = getDaysBetween(period.periodStart, period.periodEnd);

            // Calculate full period charge
            let fullPeriodCharge;
            if (cycleType === 'commercial') {
                fullPeriodCharge = monthlyRate;
            } else {
                // Residential: count actual months in period
                const monthCount = countMonthsInPeriod(period.periodStart, period.periodEnd);
                fullPeriodCharge = monthCount * monthlyRate;
            }

            // Calculate active days using helper function
            const activeDays = calculateActiveDays(serviceType, serviceDate, period.periodStart, period.periodEnd);

            // Use consistent per-day rate for the entire period
            const perDayRate = fullPeriodCharge / totalDays;  // Full precision, no rounding
            const proratedAmount = perDayRate * activeDays;  // Full precision calculation

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const alreadyBilled = today >= period.billDate;

            return {
                proratedAmount: proratedAmount,  // Keep full precision
                totalDays,
                activeDays,
                periodStart: period.periodStart,
                periodEnd: period.periodEnd,
                billDate: period.billDate,
                alreadyBilled,
                monthlyRate,
                fullPeriodCharge: fullPeriodCharge,  // Keep full precision
                perDayRate: perDayRate  // Keep full precision - do NOT round
            };
        }

        function generateResultMessage(result, cycleType, serviceType, serviceDate) {
            const { proratedAmount, activeDays, totalDays, periodStart, periodEnd, billDate, alreadyBilled, monthlyRate, fullPeriodCharge, perDayRate } = result;
            const cycleName = billingCycles[cycleType].name;
            const unusedDays = totalDays - activeDays;

            let message = `<strong>Period:</strong> ${formatDate(periodStart)} to ${formatDate(periodEnd)}<br>`;
            message += `<strong>Cycle:</strong> ${cycleName}<br>`;
            message += `<strong>Monthly Rate:</strong> ${formatCurrency(monthlyRate)}<br>`;
            message += `<strong>Full Period Charge:</strong> ${formatCurrency(fullPeriodCharge)}<br>`;
            message += `<strong>Per Day Rate:</strong> $${perDayRate} <em>(full precision)</em><br>`;
            message += `<strong>Total Days in Period:</strong> ${totalDays} days<br>`;
            message += `<strong>Active Service Days:</strong> ${activeDays} days<br>`;
            message += `<strong># of Unused Service Days:</strong> ${unusedDays} days<br><br>`;

            if (alreadyBilled) {
                if (serviceType === 'stop') {
                    const unusedAmount = fullPeriodCharge - proratedAmount;
                    message += `<strong>Billing Status:</strong> The invoice for this period was issued on ${formatDate(billDate)}. `;
                    message += `The customer was billed for the full period (${formatCurrency(fullPeriodCharge)}). `;
                    message += `Since service ended on ${formatDate(serviceDate)}, <strong>credit ${formatCurrency(unusedAmount)}</strong> for the unused portion of the service period.`;
                } else {
                    message += `<strong>Billing Status:</strong> The invoice for this period was already issued on ${formatDate(billDate)}. `;
                    message += `The customer has not been billed for service starting ${formatDate(serviceDate)}. `;
                    message += `They should be charged <strong>${formatCurrency(proratedAmount)}</strong> for the remaining days of the period.`;
                }
            } else {
                message += `<strong>Billing Status:</strong> The invoice for this period (scheduled for ${formatDate(billDate)}) has not been generated yet. `;
                message += `No separate adjustment needed – the next bill will include the prorated charge of <strong>${formatCurrency(proratedAmount)}</strong>.`;
            }

            return message;
        }

        // Form Handling
        const form = document.getElementById('prorationForm');
        const resultContainer = document.getElementById('resultContainer');
        const resultAmount = document.getElementById('resultAmount');
        const resultMessage = document.getElementById('resultMessage');
        const errorMessage = document.getElementById('errorMessage');

        form.addEventListener('submit', (e) => {
            e.preventDefault();

            // Hide previous results and errors
            resultContainer.classList.remove('show');
            errorMessage.classList.remove('show');

            // Get form values
            const cycleType = document.getElementById('invoiceCycle').value;
            const serviceType = document.querySelector('input[name="serviceType"]').value;
            const serviceDateInput = document.getElementById('serviceDate').value;
            const serviceRate = parseFloat(document.getElementById('serviceRate').value);
            const notes = document.getElementById('notes').value;

            // Validate inputs
            if (!cycleType) {
                showError('Please select an invoice cycle.');
                return;
            }

            if (!serviceDateInput) {
                showError('Please enter a service date.');
                return;
            }

            if (!serviceRate || serviceRate <= 0) {
                showError('Please enter a valid service rate greater than $0.');
                return;
            }

            if (serviceRate < MIN_MONTHLY_RATE) {
                showError(`Monthly rate must be at least $${MIN_MONTHLY_RATE.toFixed(2)}.`);
                return;
            }

            if (serviceRate > MAX_MONTHLY_RATE) {
                showError(`Monthly rate cannot exceed $${MAX_MONTHLY_RATE.toLocaleString()}.`);
                return;
            }

            const serviceDate = new Date(serviceDateInput + 'T00:00:00');

            // Validate date is valid
            if (isNaN(serviceDate.getTime())) {
                showError('Please enter a valid date.');
                return;
            }

            // Warn if date is more than 2 years old
            const twoYearsAgo = new Date();
            twoYearsAgo.setFullYear(twoYearsAgo.getFullYear() - 2);
            if (serviceDate < twoYearsAgo) {
                if (!confirm('Warning: This date is more than 2 years old. Do you want to continue?')) {
                    return;
                }
            }

            // Warn if date is in the future (more than 1 day)
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0);
            if (serviceDate > tomorrow) {
                if (!confirm('Warning: This date is in the future. Do you want to continue?')) {
                    return;
                }
            }

            // Calculate proration
            try {
                const result = calculateProration(cycleType, serviceType, serviceDate, serviceRate);
                const message = generateResultMessage(result, cycleType, serviceType, serviceDate);

                // Display results
                if (result.alreadyBilled) {
                    // Already billed - adjustment needed
                    if (serviceType === 'stop') {
                        const unusedAmount = result.fullPeriodCharge - result.proratedAmount;
                        resultAmount.textContent = formatCurrency(unusedAmount) + ' (Credit)';
                    } else {
                        // Start after billing - need to charge
                        resultAmount.textContent = formatCurrency(result.proratedAmount) + ' (Charge)';
                    }
                } else {
                    // Not yet billed - no separate adjustment needed
                    resultAmount.textContent = 'No Adjustment Needed';
                }

                resultMessage.innerHTML = message;
                resultContainer.classList.add('show');

                // Generate calculation breakdown
                generateCalculationBreakdown(result, cycleType, serviceType, serviceDate);

                // Generate visual timeline
                generateVisualTimeline(result, cycleType, serviceType, serviceDate);

                // Store current result for copy functions
                window.currentCalculationResult = {
                    result,
                    cycleType,
                    serviceType,
                    serviceDate,
                    message
                };

                // Add to audit log
                addToAuditLog({
                    timestamp: new Date(),
                    cycleType,
                    cycleName: billingCycles[cycleType].name,
                    serviceType,
                    serviceDate,
                    proratedAmount: result.proratedAmount,
                    monthlyRate: result.monthlyRate,
                    fullPeriodCharge: result.fullPeriodCharge,
                    perDayRate: result.perDayRate,
                    alreadyBilled: result.alreadyBilled,
                    notes,
                    activeDays: result.activeDays,
                    totalDays: result.totalDays
                });
            } catch (error) {
                showError('An error occurred during calculation. Please check your inputs and try again.');
                console.error(error);
            }
        });

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('show');
        }

        // Generate visual timeline
        function generateVisualTimeline(result, cycleType, serviceType, serviceDate) {
            const { activeDays, totalDays, periodStart, periodEnd } = result;
            const unusedDays = totalDays - activeDays;
            const activePercent = (activeDays / totalDays) * 100;
            const unusedPercent = (unusedDays / totalDays) * 100;

            // Calculate service date position
            let markerPercent;
            if (serviceType === 'start') {
                // Start date position from beginning
                markerPercent = ((getDaysBetween(periodStart, serviceDate) - 1) / totalDays) * 100;
            } else {
                // Stop date position
                markerPercent = ((getDaysBetween(periodStart, serviceDate)) / totalDays) * 100;
            }

            let timeline = `
                <div class="visual-timeline">
                    <div class="timeline-label">
                        <span><strong>Period Start:</strong> ${formatDate(periodStart)}</span>
                        <span><strong>Period End:</strong> ${formatDate(periodEnd)}</span>
                    </div>
                    <div class="timeline-bar-container">
                        ${serviceType === 'start' ? `
                            <div class="timeline-bar unused" style="width: ${markerPercent}%;"></div>
                            <div class="timeline-bar active" style="width: ${activePercent}%; left: ${markerPercent}%;"></div>
                        ` : `
                            <div class="timeline-bar active" style="width: ${activePercent}%;"></div>
                            <div class="timeline-bar unused" style="width: ${unusedPercent}%;"></div>
                        `}
                        <div class="timeline-marker" style="left: ${markerPercent}%;">
                            <div class="timeline-marker-label">${serviceType === 'start' ? '▶️' : '⏹️'} ${formatDate(serviceDate)}</div>
                        </div>
                    </div>
                    <div class="timeline-legend">
                        <div class="timeline-legend-item">
                            <div class="timeline-legend-color" style="background: linear-gradient(90deg, var(--success-color), var(--accent-primary));"></div>
                            <span>Active Service (${activeDays} days)</span>
                        </div>
                        <div class="timeline-legend-item">
                            <div class="timeline-legend-color" style="background: linear-gradient(90deg, var(--error-color), #ff8a80);"></div>
                            <span>Unused Service (${unusedDays} days)</span>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('visualTimeline').innerHTML = timeline;
        }

        // Generate calculation breakdown
        function generateCalculationBreakdown(result, cycleType, serviceType, serviceDate) {
            const { proratedAmount, activeDays, totalDays, periodStart, periodEnd, fullPeriodCharge, perDayRate } = result;
            const unusedDays = totalDays - activeDays;
            const cycleName = billingCycles[cycleType].name;

            let breakdown = `<div class="breakdown-line"><strong>Calculation Breakdown:</strong></div>`;
            breakdown += `<div class="breakdown-line">Period: ${formatDate(periodStart)} to ${formatDate(periodEnd)}</div>`;
            breakdown += `<div class="breakdown-line">Billing Cycle: ${cycleName}</div>`;
            breakdown += `<div class="breakdown-line">Total Days in Period: ${totalDays} days</div>`;
            breakdown += `<div class="breakdown-line">Full Period Charge: ${formatCurrency(fullPeriodCharge)}</div>`;
            breakdown += `<div class="breakdown-line"></div>`;
            breakdown += `<div class="breakdown-line">Per Day Rate = Full Period Charge ÷ Total Days</div>`;
            breakdown += `<div class="breakdown-line">Per Day Rate = ${formatCurrency(fullPeriodCharge)} ÷ ${totalDays}</div>`;
            breakdown += `<div class="breakdown-line">Per Day Rate = $${perDayRate}</div>`;
            breakdown += `<div class="breakdown-line"></div>`;
            breakdown += `<div class="breakdown-line">Service ${serviceType === 'start' ? 'Started' : 'Stopped'}: ${formatDate(serviceDate)}</div>`;
            breakdown += `<div class="breakdown-line">Active Days: ${activeDays} days</div>`;
            breakdown += `<div class="breakdown-line">Unused Days: ${unusedDays} days</div>`;
            breakdown += `<div class="breakdown-line"></div>`;
            breakdown += `<div class="breakdown-line">Prorated Amount = Per Day Rate × Active Days</div>`;
            breakdown += `<div class="breakdown-line">Prorated Amount = $${perDayRate} × ${activeDays}</div>`;
            breakdown += `<div class="breakdown-line">Prorated Amount = ${formatCurrency(proratedAmount)}</div>`;

            if (result.alreadyBilled && serviceType === 'stop') {
                const creditAmount = fullPeriodCharge - proratedAmount;
                breakdown += `<div class="breakdown-line"></div>`;
                breakdown += `<div class="breakdown-line">Credit Amount = Full Period Charge - Prorated Amount</div>`;
                breakdown += `<div class="breakdown-line">Credit Amount = ${formatCurrency(fullPeriodCharge)} - ${formatCurrency(proratedAmount)}</div>`;
                breakdown += `<div class="breakdown-result">Credit Amount = ${formatCurrency(creditAmount)}</div>`;
            } else {
                breakdown += `<div class="breakdown-result">Final Prorated Amount = ${formatCurrency(proratedAmount)}</div>`;
            }

            document.getElementById('calculationBreakdown').innerHTML = breakdown;
        }

        // Copy to clipboard functionality
        function copyToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('Copied to clipboard!');
                }).catch(err => {
                    // Fallback for older browsers
                    fallbackCopy(text);
                });
            } else {
                fallbackCopy(text);
            }
        }

        function fallbackCopy(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.opacity = '0';
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                alert('Copied to clipboard!');
            } catch (err) {
                alert('Failed to copy to clipboard.');
            }
            document.body.removeChild(textArea);
        }

        // Show/hide breakdown button
        document.getElementById('showBreakdownBtn').addEventListener('click', () => {
            const breakdown = document.getElementById('calculationBreakdown');
            const btn = document.getElementById('showBreakdownBtn');
            if (breakdown.classList.contains('show')) {
                breakdown.classList.remove('show');
                btn.textContent = 'Show Calculation Details';
            } else {
                breakdown.classList.add('show');
                btn.textContent = 'Hide Calculation Details';
            }
        });

        // Copy result amount
        document.getElementById('copyResultBtn').addEventListener('click', () => {
            if (!window.currentCalculationResult) return;
            const { result, serviceType } = window.currentCalculationResult;
            let amount;
            if (result.alreadyBilled && serviceType === 'stop') {
                amount = result.fullPeriodCharge - result.proratedAmount;
            } else if (result.alreadyBilled) {
                amount = result.proratedAmount;
            } else {
                copyToClipboard('No Adjustment Needed');
                return;
            }
            copyToClipboard(formatCurrency(amount));
        });

        // Copy summary
        document.getElementById('copySummaryBtn').addEventListener('click', () => {
            if (!window.currentCalculationResult) return;
            const { result, cycleType, serviceType, serviceDate } = window.currentCalculationResult;
            const cycleName = billingCycles[cycleType].name;
            const unusedDays = result.totalDays - result.activeDays;

            let summary = `Recology King County - Service Proration\n`;
            summary += `===========================================\n`;
            summary += `Date: ${new Date().toLocaleString()}\n\n`;
            summary += `Period: ${formatDate(result.periodStart)} to ${formatDate(result.periodEnd)}\n`;
            summary += `Cycle: ${cycleName}\n`;
            summary += `Service ${serviceType === 'start' ? 'Started' : 'Stopped'}: ${formatDate(serviceDate)}\n`;
            summary += `Monthly Rate: ${formatCurrency(result.monthlyRate)}\n`;
            summary += `Full Period Charge: ${formatCurrency(result.fullPeriodCharge)}\n`;
            summary += `Per Day Rate: $${result.perDayRate}\n`;
            summary += `Total Days: ${result.totalDays}\n`;
            summary += `Active Days: ${result.activeDays}\n`;
            summary += `Unused Days: ${unusedDays}\n`;
            summary += `Prorated Amount: ${formatCurrency(result.proratedAmount)}\n`;

            if (result.alreadyBilled && serviceType === 'stop') {
                const creditAmount = result.fullPeriodCharge - result.proratedAmount;
                summary += `\nADJUSTMENT: Credit ${formatCurrency(creditAmount)}\n`;
            } else if (result.alreadyBilled && serviceType === 'start') {
                summary += `\nADJUSTMENT: Charge ${formatCurrency(result.proratedAmount)}\n`;
            } else {
                summary += `\nADJUSTMENT: No Adjustment Needed\n`;
            }

            copyToClipboard(summary);
        });

        // Helper function to calculate business days between two dates
        function getBusinessDaysDifference(date1, date2) {
            let count = 0;
            let current = new Date(date1);
            const end = new Date(date2);

            // Ensure we're comparing dates only (no time)
            current.setHours(0, 0, 0, 0);
            end.setHours(0, 0, 0, 0);

            while (current < end) {
                const dayOfWeek = current.getDay();
                // 0 = Sunday, 6 = Saturday
                if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                    count++;
                }
                current.setDate(current.getDate() + 1);
            }

            return count;
        }

        // Filter out entries older than 3 business days
        function cleanupOldEntries(log) {
            const now = new Date();
            return log.filter(entry => {
                const entryDate = new Date(entry.timestamp);
                const businessDays = getBusinessDaysDifference(entryDate, now);
                return businessDays <= AUDIT_LOG_RETENTION_DAYS;
            });
        }

        // Audit Log Management with error handling
        function getAuditLog() {
            try {
                const log = localStorage.getItem('auditLog');
                const parsedLog = log ? JSON.parse(log) : [];

                // Clean up old entries automatically
                const cleanedLog = cleanupOldEntries(parsedLog);

                // Save back if we removed anything
                if (cleanedLog.length !== parsedLog.length) {
                    saveAuditLog(cleanedLog);
                }

                return cleanedLog;
            } catch (error) {
                console.error('Failed to retrieve audit log from localStorage:', error);
                return [];
            }
        }

        function saveAuditLog(log) {
            try {
                // Limit log size to prevent localStorage overflow
                const limitedLog = log.slice(0, MAX_AUDIT_LOG_ENTRIES);
                localStorage.setItem('auditLog', JSON.stringify(limitedLog));
            } catch (error) {
                console.error('Failed to save audit log to localStorage:', error);
                // Optionally notify user
                alert('Warning: Unable to save calculation history. Your browser storage may be full.');
            }
        }

        function addToAuditLog(entry) {
            const log = getAuditLog();
            log.unshift(entry); // Add to beginning
            saveAuditLog(log);
            renderAuditLog();
        }

        function renderAuditLog(searchTerm = '', filterType = 'all') {
            const log = getAuditLog();
            const auditLogContainer = document.getElementById('auditLog');

            if (log.length === 0) {
                auditLogContainer.innerHTML = '<div class="empty-log">No calculations yet. Fill out the form above to get started.</div>';
                return;
            }

            // Filter and search logic
            let filteredLog = log.filter(entry => {
                // Apply search filter
                if (searchTerm) {
                    const searchLower = searchTerm.toLowerCase();
                    const serviceDate = new Date(entry.serviceDate);
                    const matchesSearch =
                        (entry.cycleName && entry.cycleName.toLowerCase().includes(searchLower)) ||
                        (entry.notes && entry.notes.toLowerCase().includes(searchLower)) ||
                        formatDate(serviceDate).toLowerCase().includes(searchLower) ||
                        entry.serviceType.toLowerCase().includes(searchLower);

                    if (!matchesSearch) return false;
                }

                // Apply type filter
                if (filterType !== 'all') {
                    if (filterType === 'start' && entry.serviceType !== 'start') return false;
                    if (filterType === 'stop' && entry.serviceType !== 'stop') return false;
                    if (filterType === 'credit' && (!entry.alreadyBilled || entry.serviceType !== 'stop')) return false;
                    if (filterType === 'charge' && (!entry.alreadyBilled || entry.serviceType !== 'start')) return false;
                }

                return true;
            });

            if (filteredLog.length === 0) {
                auditLogContainer.innerHTML = '<div class="empty-log">No matching entries found.</div>';
                return;
            }

            auditLogContainer.innerHTML = filteredLog.map(entry => {
                const timestamp = new Date(entry.timestamp);
                const serviceDate = new Date(entry.serviceDate);

                // Support both old and new format
                const fullPeriodCharge = entry.fullPeriodCharge || entry.serviceRate || 0;
                const monthlyRate = entry.monthlyRate || entry.serviceRate || 0;
                const unusedDays = entry.totalDays - entry.activeDays;
                const perDayRate = entry.perDayRate || (fullPeriodCharge / entry.totalDays) || 0;

                const adjustmentType = entry.alreadyBilled && entry.serviceType === 'stop' ? 'Credit' : 'Charge';
                const displayAmount = entry.alreadyBilled && entry.serviceType === 'stop'
                    ? formatCurrency(fullPeriodCharge - entry.proratedAmount) + ' (Credit)'
                    : formatCurrency(entry.proratedAmount);

                return `
                    <div class="log-entry">
                        <div class="log-entry-header">
                            <div>
                                <strong>${entry.serviceType === 'start' ? '▶️ Start' : '⏹️ Stop'}</strong> - ${formatDate(serviceDate)}
                            </div>
                            <div class="log-entry-amount">${displayAmount}</div>
                        </div>
                        <div class="log-entry-details">
                            <strong>Cycle:</strong> ${entry.cycleName}<br>
                            <strong>Monthly Rate:</strong> ${formatCurrency(monthlyRate)}<br>
                            <strong>Full Period Charge:</strong> ${formatCurrency(fullPeriodCharge)}<br>
                            <strong>Per Day Rate:</strong> $${perDayRate}<br>
                            <strong>Active Days:</strong> ${entry.activeDays} of ${entry.totalDays} days<br>
                            <strong>Unused Days:</strong> ${unusedDays} days<br>
                            <strong>Calculated:</strong> ${timestamp.toLocaleString()}<br>
                            <strong>Status:</strong> ${entry.alreadyBilled ? 'Already Billed' : 'Not Yet Billed'}
                            ${entry.notes ? `<div class="log-entry-notes"><strong>Notes:</strong> ${entry.notes}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        document.getElementById('clearLog').addEventListener('click', () => {
            if (confirm('Are you sure you want to clear all calculation history? This cannot be undone.')) {
                localStorage.removeItem('auditLog');
                document.getElementById('logSearch').value = '';
                document.getElementById('logFilter').value = 'all';
                renderAuditLog();
            }
        });

        // Search and filter event listeners
        document.getElementById('logSearch').addEventListener('input', (e) => {
            const searchTerm = e.target.value;
            const filterType = document.getElementById('logFilter').value;
            renderAuditLog(searchTerm, filterType);
        });

        document.getElementById('logFilter').addEventListener('change', (e) => {
            const filterType = e.target.value;
            const searchTerm = document.getElementById('logSearch').value;
            renderAuditLog(searchTerm, filterType);
        });

        // Dashboard functionality
        function generateDashboardStats() {
            const log = getAuditLog();

            if (log.length === 0) {
                document.getElementById('dashboardStats').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary); grid-column: 1 / -1;">
                        No data available yet. Perform some calculations to see analytics.
                    </div>
                `;
                document.getElementById('dashboardActivityBreakdown').innerHTML = '';
                return;
            }

            // Calculate statistics
            let totalCalculations = log.length;
            let totalCredits = 0;
            let totalCharges = 0;
            let noAdjustmentCount = 0;
            let commercialCount = 0;
            let residentialCount = 0;

            log.forEach(entry => {
                const fullPeriodCharge = entry.fullPeriodCharge || (entry.monthlyRate * 3) || 0;

                if (entry.alreadyBilled && entry.serviceType === 'stop') {
                    totalCredits += (fullPeriodCharge - entry.proratedAmount);
                } else if (entry.alreadyBilled && entry.serviceType === 'start') {
                    totalCharges += entry.proratedAmount;
                } else {
                    noAdjustmentCount++;
                }

                if (entry.cycleType === 'commercial') {
                    commercialCount++;
                } else {
                    residentialCount++;
                }
            });

            // Display stats
            document.getElementById('dashboardStats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${totalCalculations}</div>
                    <div class="stat-label">Total Calculations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: var(--error-color);">${formatCurrency(totalCredits)}</div>
                    <div class="stat-label">Total Credits</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: var(--success-color);">${formatCurrency(totalCharges)}</div>
                    <div class="stat-label">Total Charges</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${noAdjustmentCount}</div>
                    <div class="stat-label">No Adjustment</div>
                </div>
            `;

            // Activity breakdown
            let breakdownHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="padding: 15px; background: var(--bg-secondary); border-radius: 8px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--accent-primary);">${commercialCount}</div>
                        <div style="font-size: 0.875rem; color: var(--text-secondary);">Commercial Cycles</div>
                    </div>
                    <div style="padding: 15px; background: var(--bg-secondary); border-radius: 8px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--accent-primary);">${residentialCount}</div>
                        <div style="font-size: 0.875rem; color: var(--text-secondary);">Residential Cycles</div>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <strong>Data Retention:</strong> Calculations are automatically deleted after ${AUDIT_LOG_RETENTION_DAYS} business days.
                </div>
            `;

            document.getElementById('dashboardActivityBreakdown').innerHTML = breakdownHTML;
        }

        // Dashboard open/close
        document.getElementById('dashboardBtn').addEventListener('click', () => {
            generateDashboardStats();
            document.getElementById('dashboardOverlay').classList.add('show');
        });

        document.getElementById('dashboardClose').addEventListener('click', () => {
            document.getElementById('dashboardOverlay').classList.remove('show');
        });

        // Close dashboard when clicking outside
        document.getElementById('dashboardOverlay').addEventListener('click', (e) => {
            if (e.target.id === 'dashboardOverlay') {
                document.getElementById('dashboardOverlay').classList.remove('show');
            }
        });

        // Clock update function
        function updateClock() {
            const now = new Date();

            // Format date as MM/DD/YY
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const year = String(now.getFullYear()).slice(-2);
            const dateStr = `${month}/${day}/${year}`;

            // Format time as HH:MM:SS
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const timeStr = `${hours}:${minutes}:${seconds}`;

            document.getElementById('clockDate').textContent = dateStr;
            document.getElementById('clockTime').textContent = timeStr;
        }

        // Update clock every second
        setInterval(updateClock, 1000);
        updateClock(); // Initial update

        // Initialize
        initTheme();
        renderAuditLog();
    </script>

    <footer style="text-align: center; padding: 20px 0; margin-top: 40px; border-top: 1px solid var(--border-color); color: var(--text-secondary); font-size: 0.75rem;">
        <div style="margin-bottom: 5px;">Version 1.0</div>
        <div>
            <a href="https://recology001.sharepoint.com/sites/KnowledgeBase/SitePages/AMCS-Platform-Reference.aspx?web=1"
               target="_blank"
               style="color: var(--accent-primary); text-decoration: none;">
                The Recology/AMCS Infostation
            </a>
        </div>
    </footer>
</body>
</html>
